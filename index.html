<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Купоны Burger King</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Стили остаются без изменений */
    </style>
</head>
<body>
    <!-- HTML остался без изменений -->
    <script>
        const SPREADSHEET_ID = '14cVlSmC6zdQo2OVtiAxrS1qtfRXvasZr_px4B9G3Kiw';

        // DOM Elements
        const couponsContainer = document.getElementById('coupons');
        const searchInput = document.getElementById('search');
        const suggestionsContainer = document.getElementById('suggestions');
        const modal = document.getElementById('modal');
        const closeModalBtn = document.querySelector('.close-modal');

        // State
        let restaurants = {};
        let coupons = [];
        let currentSuggestions = [];
        let highlightedIndex = -1;

        // Функция для извлечения JSON из ответа Google
        function parseGoogleResponse(text) {
            const jsonStart = text.indexOf('{');
            const jsonEnd = text.lastIndexOf('}');
            const jsonString = text.substring(jsonStart, jsonEnd + 1);
            return JSON.parse(jsonString);
        }

        // Извлечение URL изображения из формулы IMAGE()
        function extractImageUrl(formula) {
            if (!formula) return 'https://placehold.co/600x400?text=Изображение+недоступно';
            
            // Попытка извлечь URL из формулы IMAGE("url")
            const match = formula.match(/https?:\/\/[^\s"]+/);
            if (match) return match[0].trim();
            
            // Если это уже прямой URL
            if (formula.startsWith('http')) return formula.trim();
            
            // Возврат заглушки если ничего не найдено
            return 'https://placehold.co/600x400?text=Изображение+недоступно';
        }

        // Парсинг ID ресторанов из ячейки
        function parseRestaurantIds(cell) {
            if (!cell) return [];
            const str = cell.toString().trim();
            const cleanStr = str.replace(/[^0-9,\[\]]/g, '');
            const arrayMatch = cleanStr.match(/\[([0-9,]+)\]/);
            if (arrayMatch && arrayMatch[1]) {
                return arrayMatch[1].split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            }
            const commaMatch = cleanStr.match(/(?:\d+\s*,\s*)*\d+/g);
            if (commaMatch) {
                return cleanStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
            }
            const singleId = parseInt(cleanStr);
            if (!isNaN(singleId)) {
                return [singleId];
            }
            return [];
        }

        // Очистка адреса от лишних символов
        function cleanAddress(address) {
            if (!address) return '';
            return address
                .replace(/[^\w\sа-яА-ЯёЁ\-.,]/gi, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Загрузка данных с листа
        async function loadSheetData(sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&tq&sheet=${encodeURIComponent(sheetName)}`;
            try {
                const response = await fetch(url);
                const text = await response.text();
                const data = parseGoogleResponse(text);
                return data.table.rows.map(row => 
                    row.c.map(cell => cell ? cell.v : null)
                );
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                return [];
            }
        }

        // Загрузка всех данных
        async function loadData() {
            try {
                // Загрузка ресторанов
                const restaurantRows = await loadSheetData('РЕСТОРАНЫ');
                restaurants = {};
                for (let i = 1; i < restaurantRows.length; i++) {
                    const row = restaurantRows[i];
                    const id = row[0];
                    const address = cleanAddress(row[2]); // Очищаем адрес
                    if (id && address) {
                        restaurants[id] = address;
                    }
                }

                // Загрузка купонов
                const couponRows = await loadSheetData('СКИДКИ');
                coupons = [];
                
                for (let i = 1; i < couponRows.length; i++) {
                    const row = couponRows[i];
                    if (!row[2]) continue; // Пропускаем пустые строки
                    
                    const imageFormula = row[0] || ''; // Столбец A с формулой IMAGE
                    const imageUrl = extractImageUrl(imageFormula);
                    const name = row[2] || '';
                    const description = row[3] || '';
                    const price = row[5] || '';
                    const couponCode = row[12] || '';
                    const restaurantIds = parseRestaurantIds(row[13] || '');

                    console.log(`Coupon ${i}:`);
                    console.log(`- Image Formula: ${imageFormula}`);
                    console.log(`- Extracted Image URL: ${imageUrl}`);
                    console.log(`- Name: ${name}`);
                    console.log(`- Description: ${description}`);
                    console.log(`- Price: ${price}`);
                    console.log(`- Coupon Code: ${couponCode}`);
                    console.log(`- Restaurant IDs: ${restaurantIds}`);

                    coupons.push({
                        id: i,
                        image: imageUrl,
                        name,
                        description,
                        price,
                        couponCode,
                        restaurantIds
                    });
                }

                renderCoupons(coupons);
            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
                couponsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Ошибка загрузки данных</h3>
                        <p>Не удалось загрузить купоны. Попробуйте позже.</p>
                    </div>
                `;
            }
        }

        // Render coupons
        function renderCoupons(couponsToShow) {
            if (couponsToShow.length === 0) {
                couponsContainer.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Купоны не найдены</h3>
                        <p>Попробуйте изменить поисковый запрос</p>
                    </div>
                `;
                return;
            }

            couponsContainer.innerHTML = '';
            
            couponsToShow.forEach(coupon => {
                const couponElement = document.createElement('div');
                couponElement.className = 'coupon-card';
                couponElement.innerHTML = `
                    <img src="${coupon.image}" alt="${coupon.name}" class="coupon-image" onerror="this.src='https://placehold.co/600x400?text=Изображение+недоступно'">
                    <div class="coupon-badge">-${Math.floor(Math.random() * 30 + 10)}%</div>
                    <div class="coupon-content">
                        <h3 class="coupon-name">${coupon.name}</h3>
                        <p class="coupon-description">${coupon.description}</p>
                        <div class="coupon-footer">
                            <div class="coupon-price">${coupon.price}</div>
                            <div class="coupon-code-container">
                                <span>${coupon.couponCode}</span>
                                <button class="copy-btn" data-code="${coupon.couponCode}">
                                    <i class="fas fa-copy"></i> Копировать
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                couponsContainer.appendChild(couponElement);
            });

            // Add event listeners to copy buttons
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const code = button.getAttribute('data-code');
                    copyToClipboard(code, button);
                });
            });

            // Add event listeners to cards
            document.querySelectorAll('.coupon-card').forEach(card => {
                card.addEventListener('click', () => {
                    const couponCode = card.querySelector('.coupon-code-container span').textContent;
                    const coupon = coupons.find(c => c.couponCode === couponCode);
                    openModal(coupon);
                });
            });
        }

        // Copy to clipboard function
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        // Show suggestions
        function showSuggestions(suggestions) {
            currentSuggestions = suggestions;
            highlightedIndex = -1;
            
            if (suggestions.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestionsContainer.innerHTML = '';
            suggestions.forEach((suggestion, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion.address;
                item.dataset.id = suggestion.id;
                item.addEventListener('click', () => {
                    selectSuggestion(suggestion);
                });
                suggestionsContainer.appendChild(item);
            });
            
            suggestionsContainer.style.display = 'block';
        }

        // Highlight suggestion
        function highlightSuggestion(index) {
            const items = suggestionsContainer.querySelectorAll('.suggestion-item');
            items.forEach(item => item.classList.remove('highlighted'));
            
            if (index >= 0 && index < items.length) {
                items[index].classList.add('highlighted');
                highlightedIndex = index;
            }
        }

        // Select suggestion
        function selectSuggestion(suggestion) {
            searchInput.value = suggestion.address;
            suggestionsContainer.style.display = 'none';
            
            // Filter coupons for selected restaurant
            const filteredCoupons = coupons.filter(coupon => 
                coupon.restaurantIds.includes(suggestion.id)
            );
            
            renderCoupons(filteredCoupons);
        }

        // Filter restaurants based on search with improved logic
        function filterRestaurants(query) {
            if (!query) {
                suggestionsContainer.style.display = 'none';
                renderCoupons(coupons);
                return;
            }
            
            const cleanQuery = query.trim().toLowerCase();
            
            const filtered = Object.entries(restaurants)
                .filter(([id, address]) => {
                    const lowerAddress = address.toLowerCase();
                    const queryWords = cleanQuery.split(/\s+/);
                    return queryWords.every(word => lowerAddress.includes(word));
                })
                .map(([id, address]) => ({ id: parseInt(id), address }))
                .slice(0, 20);
            
            showSuggestions(filtered);
        }

        // Open modal with coupon details
        function openModal(coupon) {
            document.getElementById('modal-image').src = coupon.image;
            document.getElementById('modal-title').textContent = coupon.name;
            document.getElementById('modal-description').textContent = coupon.description;
            document.getElementById('modal-price').textContent = coupon.price;
            document.getElementById('modal-coupon-code').textContent = coupon.couponCode;
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Close modal
        function closeModal() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Event Listeners
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.trim();
            filterRestaurants(query);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (currentSuggestions.length === 0) return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    highlightedIndex = (highlightedIndex + 1) % currentSuggestions.length;
                    highlightSuggestion(highlightedIndex);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    highlightedIndex = (highlightedIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
                    highlightSuggestion(highlightedIndex);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (highlightedIndex >= 0) {
                        selectSuggestion(currentSuggestions[highlightedIndex]);
                    }
                    break;
                case 'Escape':
                    suggestionsContainer.style.display = 'none';
                    break;
            }
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Initialize
        loadData();
    </script>
</body>
</html>
